

### Пошаговое руководство по разработке вашего форка Chromium ("Sashai") с использованием Nix Flakes

Вы уже создали изолированное окружение для вашего проекта. Это идеальная отправная точка. Весь процесс разработки будет состоять из трех этапов: **сборка, тестирование и внесение изменений (итерация)**.

#### **Предварительные требования (у вас они, скорее всего, уже выполнены)**
1.  **Nix с поддержкой Flakes:** Убедитесь, что в вашем файле `~/.config/nix/nix.conf` (или `/etc/nix/nix.conf`) есть строки:
    ```
    experimental-features = nix-command flakes
    ```
2.  **Аппаратное обеспечение:** Как правильно отметил ваш друг, для сборки Chromium требуется мощная машина (минимум 32 ГБ ОЗУ, быстрый SSD с >100 ГБ свободного места и 8+ ядер процессора).
3.  **Ваш репозиторий:** Все команды выполняются из корня вашего нового репозитория `sashai-browser`.

---

### Шаг 1: Первая сборка проекта

Это самый долгий этап. Его цель — убедиться, что ваша текущая кодовая база (скопированная из `nixpkgs`) собирается в вашем новом Flake-окружении.

1.  **Запустите сборку:**
    Откройте терминал в корне вашего проекта и выполните команду:
    ```bash
    nix build
    ```
    *   **Что произойдет?** Nix прочитает ваш `flake.nix`, скачает указанный коммит `nixpkgs` (`e643668f...`), а затем, используя его, начнет собирать ваш пакет `sashai`, определенный в `default.nix`. Он автоматически скачает исходный код Chromium, все его зависимости, применит ваши патчи и скомпилирует браузер.
    *   **Сколько это займет?** Будьте готовы ждать **от 2 до 12 часов** в зависимости от мощности вашего компьютера.
    *   **Просмотр логов в реальном времени:** Чтобы видеть подробный вывод компиляции, используйте флаг `-L`:
        ```bash
        nix build -L
        ```

2.  **Результат сборки:**
    Если все пройдет успешно, в директории проекта появится символическая ссылка:
    ```
    ./result -> /nix/store/....-sashai-140.0.7339.207
    ```
    Она указывает на готовую сборку вашего браузера в хранилище Nix.

3.  **Решение проблем при первой сборке:**
    *   **"Out of Memory" (Нехватка памяти):** Если сборка прерывается с ошибкой, связанной с памятью, Nix обычно автоматически ограничивает количество ядер. Если проблема остается, вы можете явно ограничить их: `nix build --cores 4`.
    *   **Ошибка применения патчей:** Если в логах вы видите `patch failed`, это значит, что ваш `sashai-patches/branding.patch` не совместим с версией исходного кода Chromium. Вам нужно будет его обновить (об этом в шаге 4).

### Шаг 2: Запуск и тестирование вашего браузера

После успешной сборки вы можете запустить и проверить свой кастомный браузер.

1.  **Запуск из командной строки:**
    ```bash
    ./result/bin/chromium
    ```
    *(Примечание: исполняемый файл называется `chromium`, как определено в вашем `default.nix`, даже если имя пакета `sashai`)*.

2.  **Запуск с помощью `nix run`:**
    Это более удобный способ, который не требует наличия `result`:
    ```bash
    nix run
    ```

3.  **Что тестировать?**
    *   **Брендинг:** Самое главное — убедитесь, что ваши изменения применились. Откройте страницу `about:version` или посмотрите на заголовок окна. Вы должны увидеть "Sashai Browser" вместо "Chromium".
    *   **Основной функционал:** Посетите несколько сайтов, посмотрите видео на YouTube (если `proprietaryCodecs = true`), убедитесь, что все работает.
    *   **Отладка:** Если браузер падает, попробуйте запустить его с флагами `--no-sandbox` (небезопасно, только для отладки) или `--disable-gpu`.

---

### Шаг 3: Цикл разработки — Внесение изменений и быстрая пересборка

Это основной процесс, которым вы будете заниматься. Самая частая задача — изменение патчей. Nix идеально подходит для этого, так как он пересобирает только то, что действительно изменилось.

**Сценарий: Вы хотите изменить текст на какой-либо внутренней странице браузера.**

1.  **Получение исходного кода для создания патча:**
    Самый простой способ получить исходники в рабочем окружении — это использовать **development shell** от Nix. Сначала добавьте его в ваш `flake.nix`:

    **Добавьте этот код в ваш `flake.nix` на верхнем уровне `outputs`:**
    ```nix
    # flake.nix
    outputs = { self, nixpkgs }:
      let
        # ... ваш существующий let-блок
      in
      {
        # ... ваши существующие packages, apps и т.д.

        # Добавляем development shell
        devShells = forAllSystems (system:
          let
            pkgs = pkgsFor.${system};
          in
          {
            default = pkgs.mkShell {
              # Включаем все зависимости, необходимые для сборки
              inputsFrom = [ self.packages.${system}.default ];
            };
          });
      };
    ```

2.  **Войдите в окружение разработчика:**
    ```bash
    nix develop
    ```
    Эта команда создаст командную строку, в которой:
    *   Доступны **все инструменты для сборки** (`gn`, `ninja`, `python`, `rustc` и т.д.).
    *   Исходный код Chromium и всех его зависимостей будет **автоматически скачан и распакован**.

3.  **Создание или изменение патча:**
    *   Внутри `nix develop` выполните команду `unpackPhase`. Это стандартная команда Nix, которая распакует исходники в текущую директорию.
        ```bash
        [nix-develop]$ unpackPhase
        ```
    *   Теперь у вас есть директория `src/` с исходным кодом Chromium.
    *   Перейдите в `src/` и внесите нужные вам изменения в файлы. Например, измените файл `chrome/app/chrome_exe_main_aura.cc`.
    *   Создайте патч с помощью `git diff`. Сначала проиндексируйте изменения:
        ```bash
        [nix-develop]$ cd src
        [nix-develop]$ git add .
        [nix-develop]$ git diff --staged > ../sashai-patches/my-new-feature.patch
        ```
    *   Выйдите из `nix develop` (`exit`).

4.  **Применение нового патча:**
    *   Откройте `common.nix` и добавьте путь к вашему новому патчу в список `patches`:
        ```nix
        # common.nix
        patches = [
          ./sashai-patches/branding.patch
          ./sashai-patches/my-new-feature.patch  # <--- Ваше добавление
          ./patches/cross-compile.patch
          # ...
        ];
        ```

5.  **Быстрая пересборка:**
    Теперь снова запустите сборку:
    ```bash
    nix build
    ```
    Nix увидит, что изменился только один файл (`common.nix`) и один патч. Он **не будет заново скачивать и компилировать весь Chromium**. Он использует кешированные результаты предыдущей сборки, применит новый патч и перекомпилирует только те части, которые были затронуты. **Эта сборка займет минуты, а не часы.**

6.  **Повторяйте:** Тестируйте результат (`nix run`) и повторяйте шаги 3-5 для дальнейших изменений.

---

### Шаг 4: Обновление версии Chromium

Ваш проект содержит скрипт `update.mjs` для автоматического обновления версий и хешей в `info.json`.

1.  **Запустите скрипт:**
    ```bash
    ./update.mjs --chromium
    ```
    Этот скрипт найдет последнюю стабильную версию Chromium, обновит `info.json`, скачает зависимости и вычислит их хеши.
2.  **Пересоберите проект:**
    ```bash
    nix build
    ```
    Так как версия исходного кода изменилась, это будет **полная, долгая пересборка**. Вероятно, вам также понадобится обновить ваши патчи, чтобы они применялись к новой версии кода.

